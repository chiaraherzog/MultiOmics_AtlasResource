---
title: "Figure 5 | MEFISTO"
format:
  html:
    toc: true
    code-fold: true
    code-overflow: wrap
    code-tools: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, eval = F)
```

```{r libs, eval = F}
packages <- c('MOFA2', 'here', 'dplyr', 'ggplot2', "tidygraph", "ggraph", "patchwork", "ggtext", "ggrepel")

for(p in packages){
  if(!require(p,
              character.only = T)){
    try(install.packages(p),silent = T)
    if(!require(p,
                character.only = T)){
      BiocManager::install(p)
    } 
  }
}

library(dplyr)
library(ggplot2)
library(MOFA2)
library(here)
library(ggtext)
cols <- c("#1b69a1", "#48a0af", "#71b5a9", "#ec6669", "#f39668", "#bd647d", "#832c9b", "#5f70a8", 'grey90')
pal <- colorRampPalette(colors = cols[c(1, 2, 3, 5, 4, 6, 7, 8)])
here::i_am('mofa.qmd')

# ---- Load functions ----
source("source/plotTopFactorWeights.R")

# ---- Load trained baseline model ----
## Overall
outfile <- here('1-analyses/mofa/out', "long_medium.hdf5")
mofa_long <- load_model(outfile)

# ---- Attach phenotype metadata ----
# pheno <- readRDS(here("1-analyses/mofa/out/features_base.Rdata"))
# pheno <- pheno[samples_metadata(mofa_base)$sample,]
# samples_metadata(mofa_base) <- cbind(samples_metadata(mofa_base),
#                                      pheno)
pheno_w_mofa_long <- readRDS(here("1-analyses/mofa/out/pheno_w_mofa_long.Rdata"))

nfact <- 25
levels <- paste0("Factor", 1:nfact)

# Functions -------------
flattenCorrMatrix <- function(cormat) {
  ut <- upper.tri(cormat, diag = T)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut]
    )
}
```

This code generates graphs for figure 5. MEFISTO analyses are run in 1-analyses/mofa/ scripts.

# MEFISTO

::: {.panel-tabset}

## Figure

![](figures/Figure-6-MEFISTO-all.png)

## Code

### Panel A, variance explained

```{r long.variance.explained}
## Extract variance 
var.df <- get_variance_explained(mofa_long,as.data.frame = T)

## Sort by total variance explained -> extract order
order <- var.df$r2_total |> 
  dplyr::mutate(order = forcats::fct_reorder(view, -value)) |> 
  dplyr::arrange(order) |> 
  dplyr::pull(order)

## Panel a: by factor ----------------
a <- var.df$r2_per_factor |> 
  dplyr::mutate(view = factor(view, levels = rev(levels(order)))) |> 
  ggplot(aes(x = factor,
             y = view,
             fill = value)) +
  geom_tile(color = 'black') +
  scale_fill_gradient(low = 'white', high = cols[7],
                      name = '% var. explained') +
  scale_x_discrete(labels = c(1:25)) +
  scale_y_discrete(labels = rev(c("Blood methylation scores",
                              "Buccal methylation scores",
                              "Cervical methylation scores",
                              "Flow cytometry (T cells)",
                              "Saliva microbiome (family level)",
                              "Flow cytometry (white blood cells)",
                              "Saliva metabolome",
                              "Faecal microbiome (family level)",
                              "Urine metabolome",
                              "Cervical methylation PCs",
                              "Buccal methylation PCs",
                              "Blood methylation PCs"))) +
  theme_minimal() +
  theme(axis.ticks = element_blank(),
        legend.position = 'top',
        legend.key.height = unit(4, "mm")) +
  labs(x = 'Factor',
       y = '')

## Side panel: total variance ------------
b <- var.df$r2_total |> 
  ggplot(aes(x = forcats::fct_reorder(view, value),
             y = value)) +
  geom_col(fill = cols[7]) +
  coord_flip() +
  theme_minimal() +
  scale_y_continuous(breaks = c(0, 25, 50)) +
  theme(panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 10)) +
  labs(y = '% var.\nexplained\n(total)',
       x = '')

plot <- (a|b) +
  plot_layout(widths = c(1, 0.3))

ggsave(plot = plot,
       filename = here("figures/panels/mefisto-variance.pdf"),
       width = 8, height = 4,
       dpi = 300)

```

### Panel B, Network graph (longitudinal)

```{r long.network}
## Load data (associations - regression)
pairs_tbl_reg_05 <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_spear_krusk.Rds")) |> 
  dplyr::filter(q_value < 0.05)
pairs_tbl_05 <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_models.Rds")) |> 
  dplyr::filter(q_value < 0.05)

pairs_tbl_05 <- pairs_tbl_reg_05 |> dplyr::inner_join(pairs_tbl_05, by = c("factor_col", "feature_col")) |> 
  dplyr::rename(q_value = q_value.x) |> 
  dplyr::arrange(q_value)

## Load data (associations - regression) for plotting
pairs_tbl_reg <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_spear_krusk.Rds")) |> 
  dplyr::filter(q_value < 0.01)
pairs_tbl <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_models.Rds")) |> 
  dplyr::filter(q_value < 0.01)

pairs_tbl <- pairs_tbl_reg |> dplyr::inner_join(pairs_tbl, by = c("factor_col", "feature_col")) |> 
  dplyr::rename(q_value = q_value.x) |> 
  dplyr::arrange(q_value)

## Format and filter
fdr.graph.df <- pairs_tbl |> 
  dplyr::filter(!feature_col %in% c('bmi_at_consent',  'cig_before')) |> 
  dplyr::rename(phenotype = feature_col,
                factor = factor_col) |> 
  dplyr::mutate(qlog  = -log10(q_value + 0.000000000001)) |> 
  dplyr::select(factor, phenotype, q_value, qlog)  |> 
  dplyr::rename(
    from = factor,
    to = phenotype,
    fdr = qlog
  ) |> 
  dplyr::mutate(to = gsub("Functional.sports.exam_|Composite.methylation.scores..|Blood.haemogram_|Body.composition_|Skin.histology.and.transepidermal.water.loss.assay_|Vascular.and.body.sonography_", "", to))


# Which factors are present?
factors <- sort(as.numeric(gsub("Factor", "", unique(fdr.graph.df$from))))

## Load annotation
x <- read.table("data/vars_clinical.csv", sep = ",", header = T) 
setdiff(fdr.graph.df$to, x$x)

x <- x |> 
  dplyr::filter(x %in% fdr.graph.df$to) |> 
  dplyr::rename(category = type)


## Add annotations
fdr.graph.df <- fdr.graph.df |> 
  dplyr::left_join(dplyr::select(x, x, category, subtype, label),
                   by = c("to" = "x"))

## Generate edges
### Factor > Category
edges1 <- fdr.graph.df |>
  dplyr::filter(grepl("Factor", from)) |>
  dplyr::mutate(to = category) |>
  dplyr::select(from, to) |>
  dplyr::distinct()

### Category > Subcategory
edges1b <- fdr.graph.df |>
  dplyr::filter(grepl("Factor", from)) |>
  dplyr::mutate(from = category,
                to = subtype) |>
  dplyr::select(from, to) |>
  dplyr::distinct()

### Category > item
edges2 <- fdr.graph.df |> 
  dplyr::mutate(from = subtype) |> 
  dplyr::select(from, to) |> 
  dplyr::distinct()

### Origin > Types
edges0 <- data.frame(from = 'origin',
                     to = unique(c(edges1$from, edges1$to)))

### Final hierarchy:
edges <- rbind(edges0, edges1b, edges2) 

### Fix the order (otherwise Factor10 will come after Factor1, rather than Factor2)
edgeorder <- edges$to[!grepl("Factor", edges$to)]
edgeorder <- unique(edgeorder)
edges <- edges |> 
  dplyr::mutate(to = factor(to, levels = c(paste0("Factor", rev(factors)), 
                                           edgeorder))) |> 
  dplyr::arrange(to) |> 
  dplyr::mutate(to = as.character(to))


## Vertices (Annotation)
vertices <- tibble(name = unique(c(edges$from, edges$to))) |> 
  dplyr::arrange(name) |> 
  dplyr::left_join(dplyr::select(x, x, label), by = c("name" = "x")) 

### Fixing order again
names <- vertices$name[!grepl("Factor", vertices$name)]
vertices <- vertices |> 
  dplyr::mutate(shortName = ifelse(!is.na(label), label, name),
                name = factor(name, levels = c(paste0("Factor", rev(factors)),
                                               names))
  ) |> 
  dplyr::arrange(name) |> 
  dplyr::select(-label)

## Connections
connections <- fdr.graph.df |> 
  dplyr::select(from, to, fdr) |> 
  dplyr::distinct() |> 
  dplyr::mutate(from = factor(from, levels = paste0("Factor", rev(factors)))) |> 
  dplyr::arrange(from)

library(ggraph)
library(igraph)

## Construct graphs
fdr.hier.graph <- graph_from_data_frame(edges, directed = T, vertices = vertices)
fdr.graph <- graph_from_data_frame(connections, directed = T, vertices = vertices)

p.dend <- ggraph(fdr.hier.graph, layout = "dendrogram", circular=T, offset=200) 
p.dend$data$angle <- 90 - atan2(p.dend$data$x, p.dend$data$y)*180/pi 
p.dend$data$hjust <- ifelse(p.dend$data$angle > 90 & p.dend$data$angle <270, 1, 0)
p.dend$data$angle <- ifelse(p.dend$data$angle > 90 & p.dend$data$angle <270,  p.dend$data$angle+180, p.dend$data$angle)
# 
# p.dend + geom_edge_link()+
#   geom_node_point(aes(filter=leaf), alpha=0.3) +
#   geom_node_text(aes(label=name, filter=!leaf), angle=0, hjust=0, size=2)


# p.dend + geom_conn_bundle(data = get_con(from=match(connections$from, vertices$name),
#                                          to=match(connections$to, vertices$name) ,
#                                          fdr=connections$fdr),
#                           aes(col=name), alpha=0.7, tension=0.9, width=1, show.legend = F) +
#   geom_node_point(aes(filter=leaf), alpha=0.3) +
#   geom_node_text(aes( x*1.03, y=y*1.03,  label=name, filter=name %in% paste0("Factor",1:14), angle=angle, hjust=hjust), size=2) +
#   scale_edge_color_manual(values = pal(15), limits=paste0("Factor", 1:14)) +
#   coord_fixed() +
#   theme_void() +
#   theme(plot.margin=unit(c(0,0,0,0),"cm")) +
#   expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))
# 
# 
# p.dend + geom_conn_bundle(data = get_con(from=match(connections$from, vertices$name),
#                                          to=match(connections$to, vertices$name) ,
#                                          fdr=connections$fdr),
#                           aes(col=name), alpha=0.7, tension=0.9, width=1, show.legend = F) +
#   geom_node_point(aes(filter=leaf), alpha=0.3) +
#   geom_node_text(aes(label=name, filter=!leaf & !name %in% "origin"), hjust=0.5, size=2)+
#   geom_node_text(aes( x*1.03, y=y*1.03, label=name, filter=name %in% paste0("Factor",1:14), angle=angle, hjust=hjust), size=2)+
#   scale_edge_color_manual(values = pal(15), limits=paste0("Factor", 1:14)) +
#   coord_fixed() +
#   theme_void() +
#   theme(plot.margin=unit(c(0,0,0,0),"cm")) +
#   expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))



p <- p.dend + geom_conn_bundle(data = get_con(from=match(connections$from, vertices$name),
                                         to=match(connections$to, vertices$name) ,
                                         fdr=connections$fdr),
                          aes(col=name,
                              edge_width = fdr),
                          alpha=0.6, tension=0.9,
                          # width=1,
                          show.legend = T) +
  geom_node_point(aes(filter=leaf), alpha=0.3) +
  geom_node_text(aes( x*1.03, y=y*1.03, 
                      label=shortName,
                      filter=leaf,
                      angle=angle,
                      hjust=hjust), size=3)+
  scale_edge_color_manual(values = pal(length(unique(factors))), limits=paste0("Factor", factors)) +
  scale_edge_width(range = c(0.5, 3.5),breaks = c(3, 6, 9, 12)) +
  coord_fixed() +
  theme_void() +
  theme(legend.position = 'top') +
  theme(plot.margin=unit(c(0,0,0,0),"cm")) +
  expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))

p

pdf(file = "figures/panels/mefisto-network.pdf",
    width = 4.5,
    height = 6)
print(p)
dev.off()
```

### c, Factor correlation

```{r mefisto.cor}
mat <- pheno_w_mofa_long |> dplyr::select(contains("Factor")) |> cor() |> 
  flattenCorrMatrix() |> 
  dplyr::mutate(row = factor(row, levels = rev(levels)),
                column = factor(column, levels = levels))
  

cormat <- mat |> 
  ggplot(aes(x = column,
             y = row,
             fill = cor)) +
  # geom_tile() +
  geom_point(aes(colour = cor,
                 size = abs(cor))) +
  scale_fill_gradient2(low = cols[2], mid = 'white', high = cols[4],
                       limits = c(-1, 1),
                       aesthetics = c("colour", "fill")) +
  scale_x_discrete(labels = paste0(1:nfact)) +
  scale_y_discrete(labels = paste0(nfact:1)) +
  scale_size_continuous(breaks = c(0.3, 2.5)) +
  # theme_void()
  theme(panel.grid = element_blank(),
        panel.background = element_blank()) +
  coord_fixed()

ggsave(plot = cormat,
       filename = here("figures/panels/mefisto-corr.pdf"),
       width = 4, height = 3.5,
       dpi = 300)
```

### Panel d, Factor scatter

```{r long.factor.scatter}
factor_long <- pheno_w_mofa_long |> 
  ggplot(aes(x = Factor1,
             y = Factor2)) +
  ggforce::geom_mark_ellipse(aes(fill = studyarm,
                                 label = studyarm),
                             alpha = 0.1,
                             colour = NA) +
  geom_point(aes(colour = age_at_consent,
                 shape = studyarm),
             size = 2.2,
             alpha = 0.8) + 
  scale_color_gradientn(colours = cols[c(1, 2, 3, 5, 4)],
                        name = 'age') +
  scale_fill_manual(values = cols[c(2, 8)],
                    name = 'study arm') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  scale_shape_manual(values = c(19, 1),
                    name = 'study arm') +
  coord_cartesian(xlim = c(-0.24, 0.38),
                  ylim = c(-0.25, 0.2))

factor_long

ggsave(plot = factor_long,
       filename = here("figures/panels/mefisto-factorscatter.pdf"),
       width = 5, height = 4,
       dpi = 300)



# Subplots for the top weights:
f1 <- plotTopFactorWeights(mofa = mofa_long,
                           factorFilter = 1,
                           orientation = 'landscape')

ggsave(plot = f1$plot,
       filename = here("figures/panels/mefisto-f1heat.pdf"),
       width = 7, height = 5,
       dpi = 300)


f2 <- plotTopFactorWeights(mofa = mofa_long,
                           factorFilter = 2)
ggsave(plot = f2$plot,
       filename = here("figures/panels/mefisto_f2heat.pdf"),
       width = 4.25, height = 7,
       dpi = 300)


smk_subplot <- pheno_w_mofa_long |> 
  dplyr::mutate(subjectId2 = ifelse(studyarm == 'S', subjectId, dplyr::row_number())) |> 
  dplyr::arrange(subjectId, visitId) |> 
  ggplot(aes(x = Factor1,
             y = Factor2)) +
  ggforce::geom_mark_ellipse(aes(fill = studyarm,
                                 label = studyarm),
                             alpha = 0.1,
                             colour = NA) +
  geom_point(aes(colour = smkstop),
             size = 2.2,
             alpha = 0.8) + 
  geom_path(arrow = arrow(length = unit(2.5, "mm"),
                          type = 'open'),
            aes(group = subjectId2),
            linewidth = 0.5,
            colour = 'grey20',
            alpha = 0.5) +
  scale_color_manual(values = cols[c(4, 1)],
                        name = 'smoking stop\nat visit',
                     na.value = 'grey60',
                     breaks = c("no", "yes")) +
  scale_fill_manual(values = cols[c(2, 8)],
                    name = 'study arm',
                    guide = F) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  # scale_shape_manual(values = c(19, 1),
  #                   name = 'study arm') +
  coord_cartesian(xlim = c(-0.2, 0.25),
                  ylim = c(-0.25, 0.2))


```

### Panel e, smoking cessation

```{r}
smkstop <- pheno_w_mofa_long |> 
  dplyr::mutate(smkstop = case_when(studyarm == 'S' & visitId == 'M0' ~ 'no',
                                    TRUE ~ smkstop)) |> 
  dplyr::mutate(smkstop = ifelse(is.na(smkstop) & studyarm == 'I', "I group", as.character(smkstop))) |> 
  dplyr::filter(!is.na(smkstop)) |> 
  ggplot(aes(x = visitId,
             y = Factor2,
             fill = smkstop)) +
  geom_boxplot(alpha = 0.4) +
  ggbeeswarm::geom_beeswarm(aes(colour = smkstop),dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  scale_fill_manual(values = cols[c(3, 8, 6)],
                    name = 'smoking status',
                    labels = c("N/A - I group",
                               "yes", "no"),
                    aesthetics = c("fill", "colour")) +
  theme_bw() +
  theme(legend.position = 'top')

ggsave(plot = smkstop,
       filename = here("figures/panels/mefisto-smkstop.pdf"),
       width = 3.5, height = 4,
       dpi = 300)
```

### Panel f, longitudinal change

```{r}
baseline_visit = 'M0'
long_centered <- pheno_w_mofa_long |> 
  tidyr::pivot_longer(cols = starts_with("Factor"), 
                      names_to = "Factor", 
                      values_to = "factorval") |> 
  dplyr::group_by(Factor) |> 
  dplyr::mutate(
    baseline_median = median(factorval[visitId == baseline_visit], na.rm = TRUE),
    factorval = factorval - baseline_median
  ) |> 
  dplyr::ungroup()

summary_df <- long_centered |>
  dplyr::group_by(Factor, visitId) |>
  dplyr::summarise(stat = median(factorval, na.rm = TRUE)) |> 
  dplyr::mutate(lab = ifelse(visitId == 'M6', Factor, NA))

levels <- paste0("Factor", 1:25)
factor_delta <- summary_df |> 
  dplyr::mutate(FactorOrd = factor(Factor, levels = levels)) |> 
  ggplot(aes(x = visitId, y = stat, color = FactorOrd, group = FactorOrd)) +
  geom_line(size = 1) +
  annotate("segment", y = 0, yend = 0, x = "M0", xend = "M6", linetype = 'dashed', colour = 'grey40') +
  theme_bw() +
  theme(legend.position = 'none') +
  labs(x = "VisitId", y = "median-centred change", color = "Factor") +
  coord_cartesian(ylim = c(-0.03, 0.03),
                  expand = F) +
  expand_limits(x = c(1, 5.5)) +
  scale_colour_manual(values = pal(length(unique(levels)))) +
  geom_text_repel(aes(label = lab),
                  direction = "y",
                  nudge_x = 0.5,
                  hjust = 0,
                  segment.size = 0.5,
                  segment.alpha = 0.5,
                  size = 3.5,
                  box.padding = 0.3,
                  show.legend = FALSE)

ggsave(plot = factor_delta,
       filename = here("figures/panels/mefisto-factor_delta.pdf"),
       width = 3.8, height = 4,
       dpi = 300)



plotTopFactorWeights(mofa_long, factorFilter = 8)
plotTopFactorWeights(mofa_long, factorFilter = 14)
plotTopFactorWeights(mofa_long, factorFilter = 7)
plotTopFactorWeights(mofa_long, factorFilter = 7)
plotTopFactorWeights(mofa_long, factorFilter = 12)
plotTopFactorWeights(mofa_long, factorFilter = 20)
plotTopFactorWeights(mofa_long, factorFilter = 19)
```

## Supplementary Figures

### Factor 22 - smoking

```{r}
f22 <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor22',]
a <- plotTopFactorWeights(mofa_long, factorFilter = 22)

b <- pheno_w_mofa_long |> 
  dplyr::filter(!is.na(dailycig_longitudinal)) |> 
  ggplot(aes(x = dailycig_longitudinal,
             y = Factor22)) +
  geom_point(aes(colour = visitId)) +
  ggpubr::stat_cor(method = 'spearman') +
  theme_bw() +
  theme(legend.title = element_blank()) +
  labs(x = 'Daily cigarettes')

smkstop2 <- pheno_w_mofa_long |> 
  dplyr::filter(interventionId == 'S') |> 
  dplyr::mutate(smkstop = ifelse(is.na(smkstop) & visitId == 'M0', "no", as.character(smkstop))) |> 
  dplyr::filter(!is.na(smkstop)) |> 
  ggplot(aes(x = visitId,
             y = Factor22,
             fill = smkstop)) +
  geom_boxplot(alpha = 0.4) +
  ggbeeswarm::geom_beeswarm(aes(colour = smkstop),
                            dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  scale_fill_manual(values = cols[c(8, 6)],
                    name = 'smoking status',
                    labels = c("yes", "no"),
                    aesthetics = c("fill", "colour")) +
  theme_bw() +
  theme(legend.position = 'top') +
  coord_cartesian(ylim = c(-0.1, 0.2))

plot <- (a$plot|b|smkstop2) + plot_layout(widths = c(0.6, 1, 1))

ggsave(plot,
       filename = 'figures/panels/mefisto_f22_smk.pdf',
       width = 11, height = 5)
```

### Factor 5 - Menopause

```{r}
f5 <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor5',]

a <- plotTopFactorWeights(mofa_long, factorFilter = 5)

b <- pheno_w_mofa_long |> 
  ggplot(aes(y = Factor5,
             x = menopause)) +
  geom_boxplot(aes(fill = menopause),
               alpha = 0.5,
               outlier.shape = NA) +
  ggbeeswarm::geom_beeswarm(aes(colour = menopause),
                            alpha = 0.2) +
  ggpubr::stat_compare_means(label.y.npc = 0.95) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  scale_fill_manual(values = cols[c(5, 7)],
                    aesthetics = c("fill", "colour")) +
  scale_x_discrete(labels = c("pre", "post")) +
  labs(x = 'menopause status', y = 'Factor 5')

c <- pheno_w_mofa_long |> 
  dplyr::filter(!is.na(Skin.histology.and.transepidermal.water.loss.assay_tewl)) |> 
  ggplot(aes(y = Factor5,
             x = Skin.histology.and.transepidermal.water.loss.assay_tewl)) +
    geom_point(alpha = 0.7) +
  ggpubr::stat_cor(method = 'spearman') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  labs(x = 'transepidermal water loss\n(scaled)', y = 'Factor 5')

d <- pheno_w_mofa_long |> 
  dplyr::filter(!is.na(Skin.histology.and.transepidermal.water.loss.assay_eareaum)) |> 
  ggplot(aes(y = Factor5,
             x = Skin.histology.and.transepidermal.water.loss.assay_eareaum)) +
    geom_point(alpha = 0.7) +
  ggpubr::stat_cor(method = 'spearman') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  scale_fill_manual(values = cols[c(5, 7)],
                    aesthetics = c("fill", "colour")) +
  labs(x = 'epidermal area\n(scaled)', y = 'Factor 5')

e <- pheno_w_mofa_long |> 
  ggplot(aes(y = Factor5,
             x = Blood.haemogram_neutrophils)) +
    geom_point(alpha = 0.7) +
  ggpubr::stat_cor(method = 'spearman') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  labs(x = 'neutrophil count\n(scaled)', y = 'Factor 5')

load("data/vars.Rdata")
load("data/data_raw.Rdata")
df <- as.data.frame(wideFormat(subsetByAssay(data, "Flow cytometry: white blood cell staining"), colDataCols = c("subjectId", "visitId")))
pheno_w_mofa_long_x <- pheno_w_mofa_long |> dplyr::left_join(df) |> 
  dplyr::filter(visitId != 'M12')

f <- pheno_w_mofa_long_x |> 
  ggplot(aes(x = Flow.cytometry..white.blood.cell.staining_cells_single_cells_live_monocytes_nonnegclassical_freq_of_parent,
             y = Factor5))+
  geom_point(alpha = 0.7) +
  ggpubr::stat_cor(method = 'spearman') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  labs(x = 'non-classical monocytes\n(% freq. of parent)', y = 'Factor 5')

g <- pheno_w_mofa_long_x |> 
  ggplot(aes(y = Flow.cytometry..white.blood.cell.staining_cells_single_cells_live_monocytes_nonnegclassical_freq_of_parent,
             x = menopause)) +
  geom_boxplot(aes(fill = menopause),
               alpha = 0.5,
               outlier.shape = NA) +
  ggbeeswarm::geom_beeswarm(aes(colour = menopause),
                            alpha = 0.7) +
  ggpubr::stat_compare_means(label.y.npc = 0.95) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none') +
  scale_fill_manual(values = cols[c(5, 7)],
                    aesthetics = c("fill", "colour")) +
  scale_x_discrete(labels = c("pre", "post")) +
  labs(x = 'menopause status', y = 'non-classical monocytes\n(% freq. of parent)')

design <- '
AABCCDD
EEFFG##'

plot <- (a$plot + b + c + d + e + f + g) + plot_layout(design = design)

ggsave(plot,
       filename = 'figures/panels/mefisto_f5_meno.pdf',
       width = 11, height = 10)

ggsave(a$plot,
       filename = 'figures/panels/mefisto_f5_meno_a.pdf',
       width = 4.75, height = 7)

ggsave(b,
       filename = 'figures/panels/mefisto_f5_meno_b.pdf',
       width = 2.5, height = 3.5)

ggsave(c,
       filename = 'figures/panels/mefisto_f5_meno_c.pdf',
       width = 3.5, height = 3.5)

ggsave(d,
       filename = 'figures/panels/mefisto_f5_meno_d.pdf',
       width = 3.5, height = 3.5)
ggsave(e,
       filename = 'figures/panels/mefisto_f5_meno_e.pdf',
       width = 3.5, height = 3.5)

ggsave(f,
       filename = 'figures/panels/mefisto_f5_meno_f.pdf',
       width = 3.5, height = 3.5)

ggsave(g,
       filename = 'figures/panels/mefisto_f5_meno_g.pdf',
       width = 2.5, height = 3.5)

```

### Longitudinal changes - F8

![](figures/Figure-S-MEFISTO-all.png)

```{r}
f8 <- plotTopFactorWeights(mofa_long, factorFilter = 8,orientation = 'landscape')
f8_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor8',]
ggsave(plot = f8$plot,
       filename = here("figures/panels/suppl-mefisto-f8.pdf"),
       width = 7, height = 7,
       dpi = 300)
x <- f8$data

load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f8_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')

ggsave(plot = f8_age,
       filename = here("figures/panels/suppl-mefisto-f8-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)

load("data/data_baseline_change.Rdata")
df <- data.frame(wideFormat(subsetByAssay(data, c("Composite methylation scores: cervical", 
                            "Flow cytometry: T cell staining",
                            "Flow cytometry: white blood cell staining")),
                            colDataCols = c("subjectId", "visitId"))) |>
  dplyr::filter(!visitId %in% c('M12', "M18"))
pheno_w_mofa_long_x <- pheno_w_mofa_long |> dplyr::left_join(df,
                                                             by = c("primary", "subjectId", "visitId"))


load("data/vars.Rdata") # to look up names

meth <-pheno_w_mofa_long_x |> 
  dplyr::filter(visitId != 'M0') |> 
  ggplot(aes(x = visitId,
             y = Composite.methylation.scores..cervical_globalMethylation_island_adj)) +
  geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
  geom_boxplot(aes(fill= studyarm),
               outlier.shape = NA,
               alpha = 0.2) +
  ggbeeswarm::geom_beeswarm(aes(colour = studyarm),
                            dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'top', 
        axis.title.y = element_markdown()) +
  scale_fill_manual(values = cols[c(3, 8)],
                    aesthetics = c("colour", "fill")) +
  labs(x = 'visitId', 
       y = '∆ global island methylation<br>(adjusted for ic)') +
  coord_cartesian(ylim = c(-0.015, 0.015))

cd57<-pheno_w_mofa_long_x |> 
  dplyr::filter(visitId != 'M0') |> 
  ggplot(aes(x = visitId,
             y = Flow.cytometry..T.cell.staining_lymphocytes_single_cells_live_t_cells_cd8_t_cells_dp)) +
  geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
  geom_boxplot(aes(fill= studyarm),
               outlier.shape = NA,
               alpha = 0.2) +
  ggbeeswarm::geom_beeswarm(aes(colour = studyarm),
                            dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none', 
        axis.title.y = element_markdown()) +
  scale_fill_manual(values = cols[c(3, 8)],
                    aesthetics = c("colour", "fill")) +
  labs(x = 'visitId', 
       y = '∆ CD57<sup>+</sup>CD28<sup>+</sup> cytotoxic T cells<br>') +
  coord_cartesian(ylim = c(-6, 6))


# cm <- pheno_w_mofa_long_delta |> 
#   dplyr::filter(visitId != 'M0') |> 
#   ggplot(aes(x = visitId,
#              y = Flow.cytometry..T.cell.staining_lymphocytes_single_cells_live_t_cells_cd8_t_cells_cm)) +
#   geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
#   geom_boxplot(aes(fill = studyarm),
#                outlier.shape = NA,
#                alpha = 0.2) +
#   ggbeeswarm::geom_beeswarm(aes(colour = studyarm),
#                             dodge.width = 0.7,
#                             alpha = 0.6,
#                             size = 0.8) +
#   theme_bw() +
#   theme(panel.grid = element_blank(),
#         legend.position = 'none', 
#         axis.title.y = element_markdown()) +
#   scale_fill_manual(values = cols[c(3, 8)],
#                     aesthetics = c("colour", "fill")) +
#   labs(x = 'visitId', 
#        y = '∆ central memory CD8<sup>+</sup> T cells')
# 
# cd4n <- pheno_w_mofa_long_delta |> 
#   dplyr::filter(visitId != 'M0') |> 
#   ggplot(aes(x = visitId,
#              y = Flow.cytometry..T.cell.staining_lymphocytes_single_cells_live_t_cells_cd4_t_cells_naive)) +
#   geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
#   geom_boxplot(aes(fill = studyarm),
#                outlier.shape = NA,
#                alpha = 0.2) +
#   ggbeeswarm::geom_beeswarm(aes(colour = studyarm),
#                             dodge.width = 0.7,
#                             alpha = 0.6,
#                             size = 0.8) +
#   theme_bw() +
#   theme(panel.grid = element_blank(),
#         legend.position = 'none', axis.title.y = element_markdown()) +
#   scale_fill_manual(values = cols[c(3, 8)],
#                     aesthetics = c("colour", "fill")) +
#   labs(x = 'visitId', 
#        y = '∆ naive CD4<sup>+</sup> T cells')

plot <- meth | cd57

cairo_pdf(here("figures/panels/suppl-mefisto-f8.pdf"),
       width = 6.5, height = 4.75)
print(plot)
dev.off()
```

### Longitudinal change - F19 

```{r f19}
# F19 ----------------
f19 <- plotTopFactorWeights(mofa_long, factorFilter = 19, orientation = 'landscape')
f19_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor19',]
ggsave(plot = f19$plot,
       filename = here("figures/panels/suppl-mefisto-f19.pdf"),
       width = 6, height = 7,
       dpi = 300)
x <- f19$data

load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f19_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')
ggsave(plot = f19_age,
       filename = here("figures/panels/suppl-mefisto-f19-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)


load("data/data_baseline_change.Rdata")
df <- data.frame(wideFormat(subsetByAssay(data, c("Composite methylation scores: buccal")),
                            colDataCols = c("visitId", "subjectId"))) |>
  dplyr::filter(!visitId %in% c('M12', "M18"))
pheno_w_mofa_long_x <- pheno_w_mofa_long |> dplyr::left_join(df,
                                                             by = c("primary", "subjectId", "visitId"))

ic <- pheno_w_mofa_long_x |> 
  dplyr::filter(visitId != 'M0') |> 
  ggplot(aes(x = visitId,
             y = Composite.methylation.scores..buccal_ic.y)) +
  geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
  geom_boxplot(aes(fill= studyarm),
               outlier.shape = NA,
               alpha = 0.2) +
  ggbeeswarm::geom_beeswarm(aes(colour = studyarm),
                            dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none', 
        axis.title.y = element_markdown()) +
  scale_fill_manual(values = cols[c(3, 8)],
                    aesthetics = c("colour", "fill")) +
  labs(x = 'visitId', 
       y = '∆ buccal immune cell proportion')

cairo_pdf(here("figures/panels/suppl-mefisto-f19-ic.pdf"),
       width = 3.25, height = 4)
print(ic)
dev.off()
```

### Longitudinal change - F14

```{r}
# F14 ----------------
f14 <- plotTopFactorWeights(mofa_long, factorFilter = 14, orientation = 'landscape')
f14_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor14',]
ggsave(plot = f14$plot,
       filename = here("figures/panels/suppl-mefisto-f14.pdf"),
       width = 6, height = 7,
       dpi = 300)
x <- f14$data

load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f14_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')
ggsave(plot = f14_age,
       filename = here("figures/panels/suppl-mefisto-f14-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)

# Vars -------
library(MultiAssayExperiment)
load("data/data_baseline_change.Rdata")
df <- as.data.frame(wideFormat(subsetByAssay(data, "Composite methylation scores: blood"), colDataCols = c("subjectId", "visitId")))
pheno_w_mofa_long_x <- pheno_w_mofa_long |> dplyr::left_join(df, by = c("subjectId", "visitId", "primary")) |> 
  dplyr::filter(visitId != 'M12')

age <- pheno_w_mofa_long_x |> 
  dplyr::filter(visitId != 'M0') |> 
  ggplot(aes(x = visitId,
             y = Composite.methylation.scores..blood_index_general_age))+
  geom_hline(yintercept = 0, linetype = 'dashed', colour = 'grey60') +
  geom_boxplot(outlier.shape = NA,
               alpha = 0.2) +
  ggbeeswarm::geom_beeswarm(dodge.width = 0.7,
                            alpha = 0.6,
                            size = 0.8) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = 'none', 
        axis.title.y = element_markdown()) +
  scale_fill_manual(values = cols[c(3, 8)],
                    aesthetics = c("colour", "fill")) +
  labs(x = 'visitId', 
       y = '∆ WID-general-age') +
  coord_cartesian(ylim = c(-10, 8))

cairo_pdf(here("figures/panels/suppl-mefisto-f14-index.pdf"),
       width = 3.25, height = 4)
print(age)
dev.off()
```

### Longitudinal change - F7

```{r}
f7 <- plotTopFactorWeights(mofa_long, factorFilter = 7, orientation = 'landscape')
f7_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor7',]
ggsave(plot = f7$plot,
       filename = here("figures/panels/suppl-mefisto-f7.pdf"),
       width = 6, height = 7,
       dpi = 300)
x <- f7$data

load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f7_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')
ggsave(plot = f7_age,
       filename = here("figures/panels/suppl-mefisto-f7-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)

```

### Longitudinal change - F12/F20

```{r}
f12 <- plotTopFactorWeights(mofa_long, factorFilter = 12, orientation = 'landscape')
f12_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor12',]
ggsave(plot = f12$plot,
       filename = here("figures/panels/suppl-mefisto-f12.pdf"),
       width = 6, height = 7,
       dpi = 300)
x <- f12$data

load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f12_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')
ggsave(plot = f12_age,
       filename = here("figures/panels/suppl-mefisto-f12-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)


f12_enrich <- read.table("1-analyses/mofa/out/mefisto-f12.csv", sep =",")
f12_enrich_plot <- f12_enrich |> 
  dplyr::filter(Raw.p<0.05) |> 
  tibble::rownames_to_column('X') |> 
  dplyr::slice(1:5) |> 
  dplyr::mutate(EO = hits/expected) |> 
  ggplot(aes(x = EO,
             y = forcats::fct_reorder(X, -Raw.p),
             size = -log10(Raw.p))) +
  geom_point(alpha = 0.9, colour = cols[1]) +
  scale_size_continuous(name = '-log10(p)') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'observed/expected\nmetabolic pathways (Factor12)',
       y = '')

ggsave(plot = f12_enrich_plot,
       filename = here("figures/panels/suppl-mefisto-f12-enrich.pdf"),
       width = 6, height = 2,
       dpi = 300)


f20 <- plotTopFactorWeights(mofa_long, factorFilter = 20, orientation = 'landscape')
f20_tab <- pairs_tbl_05[pairs_tbl_05$factor_col=='Factor20',]
ggsave(plot = f20$plot,
       filename = here("figures/panels/suppl-mefisto-f20.pdf"),
       width = 6, height = 7,
       dpi = 300)
x <- f20$data
load("1-analyses/MOWAS/1-out/mowas_nonmethylation_age.Rdata")
out <- x |> dplyr::left_join(total, by = c('feature' = 'var'))|>
  dplyr::mutate(sig = ifelse(p.value < 0.05, "*", "")) 

col_mid = 'white'
f20_age <- out |>
  dplyr::arrange(absval) |> 
  ggplot(aes(x = forcats::fct_reorder(label, -absval),
             y = '')) +
  geom_tile(aes(fill = estimate*10),
            color = 'black') +
  geom_text(aes(label = sig)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = 'top',
            legend.key.height = unit(4, "mm"),
            panel.grid = element_blank()) +
      scale_fill_gradient2(low = cols[1],
                           mid = col_mid,
                           high = cols[4],
                           midpoint = 0,
                           name = 'estimate change per 10 y\nchronological age'
      ) +
      coord_cartesian(expand = F) +
      labs(x = '',
           y = '')
ggsave(plot = f20_age,
       filename = here("figures/panels/suppl-mefisto-f20-age.pdf"),
       width = 5, height = 1.2,
       dpi = 300)

f20_enrich <- read.table("1-analyses/mofa/out/mefisto-f20.csv", sep =",")
f20_enrich_plot <- f20_enrich |> 
  dplyr::filter(Raw.p<0.05) |> 
  tibble::rownames_to_column('X') |> 
  dplyr::slice(1:5) |> 
  dplyr::mutate(EO = hits/expected) |> 
  ggplot(aes(x = EO,
             y = forcats::fct_reorder(X, -Raw.p),
             size = -log10(Raw.p))) +
  geom_point(alpha = 0.9, colour = cols[1]) +
  scale_size_continuous(name = '-log10(p)') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'observed/expected\nmetabolic pathways (Factor12)',
       y = '')

ggsave(plot = f20_enrich_plot,
       filename = here("figures/panels/suppl-mefisto-f20-enrich.pdf"),
       width = 6, height = 2,
       dpi = 300)



```

:::


## Supplementary Tables

```{r}
## Load data (associations - regression)
pairs_tbl_reg_05 <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_spear_krusk.Rds")) |> 
  dplyr::filter(q_value < 0.05)
pairs_tbl_05 <- readRDS(here("1-analyses/mofa/out/pairs_tbl_long_overall_models.Rds")) |> 
  dplyr::filter(q_value < 0.05)

pairs_tbl <- pairs_tbl_reg_05 |> dplyr::inner_join(pairs_tbl_05, by = c("factor_col", "feature_col")) |> 
  dplyr::rename(q_value = q_value.x) |> 
  dplyr::arrange(q_value)

# Significant associations
MEFISTO_assoc_out <- pairs_tbl |> 
  dplyr::rename(p_value_regression = p,
                regression_type = model,
                q_value_regression = q_value,
                p_value_alt = p_value,
                q_value_alt = q_value.y,
                effect_size_alt = effect_size,
                effect_label_alt = effect_label,
                feature = feature_col,
                factor = factor_col) |> 
  dplyr::select(factor, feature, beta, regression_type, p_value_regression, q_value_regression,
                effect_size_alt, effect_label_alt, p_value_alt, q_value_alt) |> 
  dplyr::arrange(factor, p_value_regression)
writexl::write_xlsx(MEFISTO_assoc_out, path = 'out/MEFISTO_associations.xlsx')

# Factor loadings (1:30 for all factors with significant associations.
source('source/extractTopFeatureWeights.R')
factors <- as.list(unique(as.numeric(gsub("Factor", "", MEFISTO_assoc_out$factor))))
factors

out <- bind_rows(lapply(factors, function(i){extractTopFactorweights(mofa_long, i)}),
                 .id = 'id') |> 
  dplyr::mutate(factor = case_match(id, 
                                    "1" ~ "Factor1",
                                    "2" ~ "Factor10",
                                    "3" ~ "Factor11",
                                    "4" ~ "Factor12",
                                    "5" ~ "Factor13",
                                    "6" ~ "Factor15",
                                    "7" ~ "Factor16",
                                    "8" ~ "Factor17",
                                    "9" ~ "Factor19",
                                    "10" ~ "Factor2",
                                    "11" ~ "Factor20",
                                    "12" ~ "Factor5",
                                    "13" ~ "Factor6",
                                    "14" ~ "Factor7",
                                    "15" ~ "Factor9"
                                    )) |> 
  dplyr::select(-id)
writexl::write_xlsx(out, path = 'out/MEFISTO_weights.xlsx')
```


